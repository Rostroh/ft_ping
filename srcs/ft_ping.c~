/* ************************************************************************** */
/*                                                                            */
/*                                                        :::      ::::::::   */
/*   ft_ping.c                                          :+:      :+:    :+:   */
/*                                                    +:+ +:+         +:+     */
/*   By: rostroh </var/mail/rostroh>                +#+  +:+       +#+        */
/*                                                +#+#+#+#+#+   +#+           */
/*   Created: 2020/12/15 19:46:05 by rostroh           #+#    #+#             */
/*   Updated: 2020/12/16 20:49:00 by rostroh          ###   ########.fr       */
/*                                                                            */
/* ************************************************************************** */

#include "ft_ping.h"

#define SIZE 84

static int		send_msg(int sock, struct sockaddr_in dst, \
		t_info data, int *seq)
{
	char			name[255];//
	char			*buffer;
	struct ip		*ip;
	struct icmp		*icmp;

	stat.nb_sent++;
	buffer = creat_payload(dst, data);
	ip = (struct ip *)buffer;
	icmp = (struct icmp *)(ip + 1);
	icmp->icmp_cksum = 0;
	icmp->icmp_seq = stat.nb_sent - 1;
	*seq = icmp->icmp_seq;
	ip->ip_sum = cksum((unsigned short *)buffer, ip->ip_hl);
	icmp->icmp_cksum = cksum((unsigned short *)icmp, \
			data.size);
	gettimeofday(&stat.tv1, NULL);
	printf("stat: send at addr : %s\n", inet_ntop(AF_INET, &stat.addr, name, 255));
	printf("dst1: send at addr : %s\n", inet_ntop(AF_INET, &dst.sin_addr, name, 255));
	/*if (strcmp(name, "127.0.0.1") == 0)
	{
		inet_pton(AF_INET, "10.0.2.15", &dst.sin_addr);
		printf("dst1.5: send at addr : %s\n", inet_ntop(AF_INET, &dst.sin_addr, name, 255));
	}*/
	printf("IP:\nVer: %d Hl: %d Tos: %d Len: %d Id: %d Off: %d Tll: %d P: %d Sum: %d\n", ip->ip_v, ip->ip_hl, ip->ip_tos, ip->ip_len, ip->ip_id, ip->ip_off, ip->ip_ttl, ip->ip_p, ip->ip_sum);
	printf("ICMP:\nType: %d Code: %d Id: %d Seq: %d Cksum: %d\n", icmp->icmp_type, icmp->icmp_code, icmp->icmp_id, icmp->icmp_seq, icmp->icmp_cksum);
	if (sendto(sock, buffer, data.size + sizeof(struct icmp), 0, \
			(struct sockaddr *)&dst, data.size + sizeof(struct icmp)) < 0)
		printf("Send error\n");
	return (data.size + sizeof(struct icmp));
}

static void		print_info(t_info data)
{
	char		name[255];

	printf("PING %s (%s) %d(%d) bytes of data\n", data.host, \
			inet_ntop(AF_INET, &stat.addr, name, 255), \
			data.size, data.size + sizeof(struct icmp));
}

void			ft_ping(struct sockaddr_in dst, t_info data)
{
	int			seq;
	int			sock;
	char		name[255];

	if ((sock = creat_socket()) < 0)
		return ;
	print_info(data);
	gettimeofday(&stat.init, NULL);
	while (stat.nb_sent < data.count || data.count == 0)
	{
		printf("dst0: send at addr : %s\n", inet_ntop(AF_INET, &dst.sin_addr, name, 255));
		send_msg(sock, dst, data, &seq);
		printf("dst2: send at addr : %s\n", inet_ntop(AF_INET, &dst.sin_addr, name, 255));
		if (read_msg(sock, &dst) > 0)
		{
			printf("dst3: send at addr : %s\n", inet_ntop(AF_INET, &dst.sin_addr, name, 255));
			gettimeofday(&stat.tv2, NULL);
			printf("%d bytes from %s: icmp_seq=%d ttl=%d time=", \
	data.size + sizeof(struct icmp) - sizeof(struct ip), \
	inet_ntop(AF_INET, &stat.addr, name, 255), seq, data.ttl);
			time_passed(stat.tv1, stat.tv2);
			stat.nb_rec++;
		}
		else
		{
			printf("dst3: send at addr : %s\n", inet_ntop(AF_INET, &dst.sin_addr, name, 255));
			printf("\nrec error\n\n");
		}
		ft_wait(data.interval);
	}
	gettimeofday(&stat.end, NULL);
	print_stat();
	close(sock);
}
